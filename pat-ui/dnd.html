<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Saiku - Next Generation Open Source Analytics</title>
        <!-- Blueprint CSS -->
        <link rel="stylesheet" href="css/blueprint/src/reset.css" type="text/css" media="screen, projection">
        <link rel="stylesheet" href="css/blueprint/src/typography.css" type="text/css" media="screen, projection">
        <link rel="stylesheet" href="css/blueprint/src/forms.css" type="text/css" media="screen, projection">
        <link rel="stylesheet" href="css/blueprint/src/grid.css" type="text/css" media="screen, projection">
        <!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/src/ie.css" type="text/css" media="screen, projection"><![endif]-->
        <!-- Saiku CSS -->
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <!-- jQuery -->
        <script src="js/jquery/src/jquery.1.4.3.js" type="text/javascript"></script>
        <!-- jQuery Plugins -->
        <script src="js/jquery/src/jquery.ui.1.8.5.js" type="text/javascript"></script>
        <style type="text/css">
            .clear {
                clear: both;
            }

            #columns,
            #rows {
                border: 1px dashed #CCC;
                margin-bottom: 10px;
                padding: 10px;
            }

            #columns ul,
            #rows ul {
                list-style: none;
                margin: 0;
                padding: 0;
                float: left;
                display: inline;
            }

            #columns ul li,
            #rows ul li {
                float: left;
                display: inline;
                margin: 0 5px;
                padding: 3px 2px;
            }

            #columns ul li ul,
            #rows ul li ul {
                float: right;
            }


            #columns a,
            #rows a {
                padding: 1px 7px;
                margin: 0 5px;
                text-decoration: none;
            }

            #columns li a.dimension,
            #rows li a.dimension {
                border: 1px solid #205791;
                background: #92cae4;
                color: #205791;
            }

            #columns li a.measure, 
            #rows li a.measure {
                border: 1px solid #8a1f11;
                background: pink;
                color: #8a1f11;
            }

            #columns li.placeholder,
            #rows li.placeholder {
                border: 1px dashed #CCC;
                background: #F0F0F0;
            }
        </style>
        <script type="text/javascript">
            $(function() {

                /** Make the column and row first level list items sortable. */
                $('#columns ul, #rows ul').sortable({
                    
                    placeholder : 'placeholder',
                    forcePlaceholderSize : true,
                    items : '> li',
                    connectWith : '.connectable',
                    
                    remove : function(event, ui) {
                        if(ui.item.hasClass('m')){
                            /** Id of the item being sorted. */
                            var measure_id = ui.item.find('a').attr('rel');
                            /** Remove the not-draggable class and add ui-draggable to the measure item. */
                            $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                            .removeClass('not-draggable').addClass('ui-draggable');
                        }else{
                            /** Id of the item being sorted. */
                            var dimension_id = ui.item.find('a').attr('rel').split('_')[0];
                            /** Remove the not-draggable class and add ui-draggable to all the sorted items sibilings. */
                            $('#dimension_tree').parent().parent().parent()
                            .find('[rel=' + dimension_id + ']').parent().children().children()
                            .removeClass('not-draggable').addClass('ui-draggable');
                        }

                    },

                    receive : function(event, ui) {
                        
                    },
                    
                    beforeStop : function(event, ui) {
                        if(!(ui.item.hasClass('dropped'))) {
                            console.log('beforeStop:');
                            /** If the user is dragging a dimension. */
                            if (ui.item.find('a').hasClass('dimension')) {
                                console.log('Sorting a dimension');
                                /** Find id of the dimension based on the rel attr. */
                                var dimension_id = ui.item.find('a').attr('rel').split('_')[0];
                                /**
                                 * Add the not-draggable class and add ui-draggable to
                                 * all the sorted items sibilings.
                                 */
                                console.log('Disable other dimensions within the same hierarchy');
                                $('#dimension_tree').parent().parent().parent()
                                .find('[rel=' + dimension_id + ']').parent().children().children()
                                .removeClass('ui-draggable').addClass('not-draggable');

                                /** Style the new dimension. */
                                ui.item.css('display', '').addClass('d');
                            }else{
                                /** If it isn't a dimension, we can assume it is a measure. */
                                /**
                                 * If this is the first measure being dropped by finding the
                                 * measures_group class.
                                 */
                                console.log('Sorting a measure');
                                if ($('#rows, #columns').find('.measures_group').length == 0) {
                                    console.log('If there is no measures_group class on the #row or #column area.');
                                    /** Add in the measures nested list after where the placeholder is. */
                                    $(this).find('.placeholder').after('<li>Measures<ul class="measures_group"/></li>');
                                }else{
                                    console.log('If there is a measures_group class on the #row or #column area.');
                                }
                            }
                        }
                    },

                    stop : function (event, ui) {
                        if(!(ui.item.hasClass('dropped'))) {
                            console.log('stop:');
                            /** If the measure being sorted is a dimension. */
                            if (ui.item.find('a').hasClass('dimension')) {
                                console.log('Finished sorting the dimension');
                            }else{
                                /** If the measure being sorted is a measure. */
                                /** Find id of the measure based on the rel attr. */
                                var measure_id = ui.item.find('a').attr('rel');
                                /** If this is the first measure being sorted in the nested measures group. */
                                if($('#columns, #rows').find('.measures_group').find('li').length == 0) {
                                    console.log('This is first sorted item in the measures group');
                                    /** Style and add the sortable measure item to the measures group. */
                                    ui.item.css('display', '').addClass('m').appendTo($('.measures_group'));
                                    /** Make the new nested measures group sortable. */
                                    $('.measures_group').sortable({
                                        forcePlaceholderSize : true,
                                        placeholder : 'placeholder',
                                        items : 'li',
                                        beforeStop  : function(event, ui) {
                                            console.log('Make .measures_group sortable');
                                            console.log('beforeStop:');
                                        },
                                        stop : function(event, ui ) {
                                            console.log('stop:');
                                            /** Find id of the measure based on the rel attr. */
                                            var measure_id = ui.item.find('a').attr('rel');
                                            /** If it isn't the first measure being sorted. */
                                            /** Style and add the sortable measure item to the measures group. */
                                            ui.item.css('display', '').addClass('m').appendTo($('.measures_group'));
                                            /**
                                             * Add the not-draggable class and add ui-draggable to
                                             * all the sorted items sibilings
                                             */
                                            $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                                            .removeClass('ui-draggable').addClass('not-draggable');
                                        }
                                    });
                                
                                    /**
                                     * Destroy the measures draggable object and reinitialise it so it points to the
                                     * measures group only.
                                     */
                                    console.log('Destroy the draggable object on the measures tree and reinitialise.')
                                    $('#measure_tree li ul li').draggable('destroy').draggable({
                                        cancel : '.not-draggable',
                                        connectToSortable : '.measures_group',
                                        helper : 'clone',
                                        revert : 'invalid'
                                    });

                                    /**
                                     * Add the not-draggable class and add ui-draggable to
                                     * all the sorted items sibilings
                                     */
                                    $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                                    .removeClass('ui-draggable').addClass('not-draggable');
                                
                                }else{
                                    console.log('If there are no other list items in the measures group.');
                                    $('#columns ul, #rows ul').sortable( "refresh" )
                                
                                }
                            }
                        }
                    }
                });

                /**
                 * Make the dimension and measure tree items draggable and
                 * connectable to the column and row areas.
                 */
                $('#dimension_tree li ul li').draggable({
                    cancel : '.not-draggable',
                    connectToSortable : '#columns ul, #rows ul',
                    helper : 'clone',
                    revert : 'invalid'
                });
                $('#measure_tree li ul li').draggable({
                    cancel : '.not-draggable',
                    connectToSortable : '#columns ul, #rows ul',
                    helper : 'clone',
                    revert : 'invalid'
                });

                $('#sidebar').droppable({
                    accept : "#rows li, #columns li, .measures_group li",

                    /**
                     * This event is triggered when an accepted draggable is dropped 'over'
                     * (within the tolerance of) this droppable (this belongs to jQuery UI).
                     * @param event {Object} jQuery UI object.
                     * @param ui {Object} jQuery UI object.
                     */
                    drop : function(event, ui) {
                        /** Add a class to the to be dropped item so that the sortable beforeStop event can detect the item being removed. */
                        ui.draggable.addClass('dropped');
                        /** Remove the draggable item. */
                        ui.draggable.remove();
                        /** Using setTimeout due to IE7+ bug with jQuery UI. */
                        setTimeout(function() {
                            ui.draggable.remove();
                        } , 1);
                    }
                });
            });
        </script>
    </head>
    <body>
        <div class="container">
            <h1 class="prepend-top"></h1>
            <div id="sidebar" class="span-6 colborder">
                <ul id="dimension_tree">
                    <li>
                        <a href="#" rel="d0">Dimension #1</a>
                        <ul>
                            <li><a class="dimension" href="#" rel="d0_0">Dimension #1a</a></li>
                            <li><a class="dimension" href="#" rel="d0_1">Dimension #1b</a></li>
                            <li><a class="dimension" href="#" rel="d0_2">Dimension #1c</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#" rel="d1">Dimension #2</a>
                        <ul>
                            <li><a class="dimension" href="#" rel="d1_0">Dimension #2a</a></li>
                            <li><a class="dimension" href="#" rel="d1_1">Dimension #2b</a></li>
                            <li><a class="dimension" href="#" rel="d1_2">Dimension #2c</a></li>
                        </ul>
                    </li>
                </ul>
                <hr/>
                <ul id="measure_tree">
                    <li><a href="#" rel="m0">Measures</a>
                        <ul>
                            <li><a class="measure" href="#" rel="m0_0">Measure #1</a></li>
                            <li><a class="measure" href="#" rel="m0_1">Measure #2</a></li>
                            <li><a class="measure" href="#" rel="m0_2">Measure #3</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="span-17 last">
                <div id="columns">
                    <ul class="connectable">
                        <li><a class="dimension" href="#">Item 1</a></li>
                    </ul>
                    <div class="clear"></div>
                </div>

                <div id="rows">
                    <ul class="connectable">
                        <li><a class="dimension" href="#">Item 1</a></li>
                    </ul>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </body>
</html>