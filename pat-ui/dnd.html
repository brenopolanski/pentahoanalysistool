<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Saiku - Next Generation Open Source Analytics</title>
        <!-- Blueprint CSS -->
        <link rel="stylesheet" href="css/blueprint/src/reset.css" type="text/css" media="screen, projection">
        <link rel="stylesheet" href="css/blueprint/src/typography.css" type="text/css" media="screen, projection">
        <link rel="stylesheet" href="css/blueprint/src/forms.css" type="text/css" media="screen, projection">
        <link rel="stylesheet" href="css/blueprint/src/grid.css" type="text/css" media="screen, projection">
        <!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/src/ie.css" type="text/css" media="screen, projection"><![endif]-->
        <!-- Saiku CSS -->
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <!-- jQuery -->
        <script src="js/jquery/src/jquery.1.4.3.js" type="text/javascript"></script>
        <!-- jQuery Plugins -->
        <script src="js/jquery/src/jquery.ui.1.8.5.js" type="text/javascript"></script>
        <style type="text/css">
            .clear {
                clear: both;
            }
            #columns,
            #rows {
                border: 1px dashed #CCC;
                margin-bottom: 10px;
                padding: 10px;
            }
            #columns ul,
            #rows ul {
                list-style: none;
                margin: 0;
                padding: 0;
                float: left;
                display: inline;
            }
            #columns ul li,
            #rows ul li {
                float: left;
                display: inline;
                margin: 0 5px;
                padding: 3px 2px;
            }
            #columns ul li ul,
            #rows ul li ul {
                float: right;
            }
            #columns a,
            #rows a {
                padding: 1px 7px;
                margin: 0 5px;
                text-decoration: none;
            }
            #columns li a.dimension,
            #rows li a.dimension {
                border: 1px solid #205791;
                background: #92cae4;
                color: #205791;
            }
            #columns li a.measure, 
            #rows li a.measure {
                border: 1px solid #8a1f11;
                background: pink;
                color: #8a1f11;
            }
            #columns li.placeholder,
            #rows li.placeholder {
                border: 1px dashed #CCC;
                background: #F0F0F0;
            }
        </style>
        <script type="text/javascript">
            /*
            $(function() {
                $('#columns ul, #rows ul').sortable({
                    connectWith : '.connectable',
                    forcePlaceholderSize : true,
                    items : '> li',
                    placeholder : 'placeholder',
                    remove : function(event, ui) {
                        if(ui.item.hasClass('m')){
                            var measure_id = ui.item.find('a').attr('rel');
                            $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                            .removeClass('not-draggable').addClass('ui-draggable');
                        }else{
                            var dimension_id = ui.item.find('a').attr('rel').split('_')[0];
                            $('#dimension_tree').parent().parent().parent()
                            .find('[rel=' + dimension_id + ']').parent().children().children()
                            .removeClass('not-draggable').addClass('ui-draggable');
                        }
                    },
                    stop : function (event, ui) {
                        if(!(ui.item.hasClass('dropped'))) {
                            if (ui.item.find('a').hasClass('dimension')) {
                                var dimension_id = ui.item.find('a').attr('rel').split('_')[0];
                                $('#dimension_tree').parent().parent().parent()
                                .find('[rel=' + dimension_id + ']').parent().children().children()
                                .removeClass('ui-draggable').addClass('not-draggable');
                                ui.item.css('display', '').addClass('d');
                            }
                        }else{
                            var measure_id = ui.item.find('a').attr('rel');
                            if($('#columns, #rows').find('.measures_group').find('li').length == 0) {
                                $(this).find('.placeholder').after('<li class="measures">Measures<ul class="measures_group"/></li>');
                                ui.item.css('display', '').addClass('m').appendTo($('.measures_group'));
                                $('.measures_group').sortable({
                                    forcePlaceholderSize : true,
                                    placeholder : 'placeholder',
                                    items : 'li',
                                    stop : function(event, ui) {
                                        var measure_id = ui.item.find('a').attr('rel');
                                        ui.item.css('display', '').addClass('m').appendTo($('.measures_group'));
                                        $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                                        .removeClass('ui-draggable').addClass('not-draggable');
                                    }
                                });
                                $('#measure_tree li ul li').draggable('destroy').draggable({
                                    cancel : '.not-draggable',
                                    connectToSortable : '.measures_group',
                                    helper : 'clone',
                                    revert : 'invalid'
                                });
                                $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                                .removeClass('ui-draggable').addClass('not-draggable');
                            }else{
                                $('#columns ul, #rows ul').sortable("refresh")
                            }
                        }
                    }
                });

                $('#dimension_tree li ul li').draggable({
                    cancel : '.not-draggable',
                    connectToSortable : '#columns > ul, #rows > ul',
                    helper : 'clone',
                    revert : 'invalid'
                });

                $('#measure_tree li ul li').draggable({
                    cancel : '.not-draggable',
                    connectToSortable : '#columns > ul, #rows > ul',
                    helper : 'clone',
                    revert : 'invalid'
                });

                $('#sidebar').droppable({
                    accept : "#rows li, #columns li, .measures_group li",
                    drop : function(event, ui) {
                        if($('.measures_group').find('.m').length == 1 || ui.draggable.hasClass('measures')) {
                            ui.draggable.addClass('dropped');
                            ui.draggable.remove();
                            setTimeout(function() {
                                ui.draggable.remove();
                            },1);
                            $('.measures').remove();
                            $('#measure_tree li ul li').draggable('destroy').draggable({
                                cancel : '.not-draggable',
                                connectToSortable : '#columns ul, #rows ul',
                                helper : 'clone',
                                revert : 'invalid'
                            });
                        }
                        ui.draggable.addClass('dropped');
                        ui.draggable.remove();
                        setTimeout(function() {
                            ui.draggable.remove();
                        },1);
                    }
                });
            });
            */
           $(function() {
                $('#columns div, #rows div').sortable({
                    connectWith : '.connectable',
                    forcePlaceholderSize : true,
                    items : '> span',
                    placeholder : 'placeholder',
                    remove : function(event, ui) {
                        if(ui.item.hasClass('m')){
                            var measure_id = ui.item.find('a').attr('rel');
                            $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                            .removeClass('not-draggable').addClass('ui-draggable');
                        }else{
                            var dimension_id = ui.item.find('a').attr('rel').split('_')[0];
                            $('#dimension_tree').parent().parent().parent()
                            .find('[rel=' + dimension_id + ']').parent().children().children()
                            .removeClass('not-draggable').addClass('ui-draggable');
                        }
                    },
                    stop : function (event, ui) {
                        if(!(ui.item.hasClass('dropped'))) {
                            if (ui.item.find('a').hasClass('dimension')) {
                                var dimension_id = ui.item.find('a').attr('rel').split('_')[0];
                                $('#dimension_tree').parent().parent().parent()
                                .find('[rel=' + dimension_id + ']').parent().children().children()
                                .removeClass('ui-draggable').addClass('not-draggable');
                                ui.item.css('display', '').addClass('d');
                            }
                        }else{
                            var measure_id = ui.item.find('a').attr('rel');
                            if($('#columns, #rows').find('.measures_group').find('li').length == 0) {
                                $(this).find('.placeholder').after('<li class="measures">Measures<ul class="measures_group"/></li>');
                                ui.item.css('display', '').addClass('m').appendTo($('.measures_group'));
                                $('.measures_group').sortable({
                                    forcePlaceholderSize : true,
                                    placeholder : 'placeholder',
                                    items : 'li',
                                    stop : function(event, ui) {
                                        var measure_id = ui.item.find('a').attr('rel');
                                        ui.item.css('display', '').addClass('m').appendTo($('.measures_group'));
                                        $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                                        .removeClass('ui-draggable').addClass('not-draggable');
                                    }
                                });
                                $('#measure_tree li ul li').draggable('destroy').draggable({
                                    cancel : '.not-draggable',
                                    connectToSortable : '.measures_group',
                                    helper : 'clone',
                                    revert : 'invalid'
                                });
                                $('#measure_tree').find('[rel=' + measure_id + ']').parent()
                                .removeClass('ui-draggable').addClass('not-draggable');
                            }else{
                                $('#columns ul, #rows ul').sortable("refresh")
                            }
                        }
                    }
                }).disableSelection();

                $('#dimension_tree li ul li').draggable({
                    cancel : '.not-draggable',
                    connectToSortable : '#columns > div, #rows > div',
                    helper : 'clone',
                    revert : 'invalid'
                }).disableSelection();

                $('#measure_tree li ul li').draggable({
                    cancel : '.not-draggable',
                    connectToSortable : '#columns > div, #rows > div',
                    helper : 'clone',
                    revert : 'invalid'
                }).disableSelection();

                $('#sidebar').droppable({
                    accept : "#rows li, #columns li, .measures_group li",
                    drop : function(event, ui) {
                        if($('.measures_group').find('.m').length == 1 || ui.draggable.hasClass('measures')) {
                            ui.draggable.addClass('dropped');
                            ui.draggable.remove();
                            setTimeout(function() {
                                ui.draggable.remove();
                            },1);
                            $('.measures').remove();
                            $('#measure_tree li ul li').draggable('destroy').draggable({
                                cancel : '.not-draggable',
                                connectToSortable : '#columns ul, #rows ul',
                                helper : 'clone',
                                revert : 'invalid'
                            });
                        }
                        ui.draggable.addClass('dropped');
                        ui.draggable.remove();
                        setTimeout(function() {
                            ui.draggable.remove();
                        },1);
                    }
                });
            });
        </script>
    </head>
    <body>
        <div class="container">
            <h1 class="prepend-top"></h1>
            <div id="sidebar" class="span-6 colborder">
                <ul id="dimension_tree">
                    <li>
                        <a href="#" rel="d0">Dimension #1</a>
                        <ul>
                            <li><a class="dimension" href="#" rel="d0_0">Dimension #1a</a></li>
                            <li><a class="dimension" href="#" rel="d0_1">Dimension #1b</a></li>
                            <li><a class="dimension" href="#" rel="d0_2">Dimension #1c</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#" rel="d1">Dimension #2</a>
                        <ul>
                            <li><a class="dimension" href="#" rel="d1_0">Dimension #2a</a></li>
                            <li><a class="dimension" href="#" rel="d1_1">Dimension #2b</a></li>
                            <li><a class="dimension" href="#" rel="d1_2">Dimension #2c</a></li>
                        </ul>
                    </li>
                </ul>
                <hr/>
                <ul id="measure_tree">
                    <li><a href="#" rel="m0">Measures</a>
                        <ul>
                            <li><a class="measure" href="#" rel="m0_0">Measure #1</a></li>
                            <li><a class="measure" href="#" rel="m0_1">Measure #2</a></li>
                            <li><a class="measure" href="#" rel="m0_2">Measure #3</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="span-17 last">
                <div id="columns">
                    <div class="connectable">
                        <span><a class="dimension" href="#">Item 1</a></span>
                    </div>
                    <div class="clear"></div>
                </div>

                <div id="rows">
                    <div class="connectable">
                        <span><a class="dimension" href="#">Item 1</a></span>
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </body>
</html>